"use strict";(function(b,a){function c(){this.body=b("body");this.ajaxurl=BonaireOptions.ajaxurl;this.defaultOptions=BonaireOptions.default_options;this.optionsMeta=BonaireOptions.options_meta;this.hasEmptyField=BonaireOptions.has_empty_field;this.saveReply=BonaireOptions.save_reply;this.alertifyNotifications=BonaireOptionsPage.alertify_notifications;this.alertifyError=BonaireOptionsPage.alertify_error;this.replyError=BonaireOptionsPage.reply_error;this.emptyMessageError=BonaireOptionsPage.empty_message_error;this.optionsPageNotifications=BonaireOptionsPage.settings_page_notifications;this.resetOptionsConfirmation=BonaireOptionsPage.reset_options_confirmation;this.helpButton=b("#connection_details a.information");this.handleDiv=b("#bonaire_dashboard_widget > button.handlediv");this.bonaireMarkAsReadButton=b(".bonaire-mark-as-read-button");this.markAsSpamButton=b(".bonaire-mark-as-spam-button");this.moveToTrashButton=b(".bonaire-move-to-trash-button");this.markAsReadAction="bonaire_mark_as_read";this.markAsSpamAction="bonaire_mark_as_spam";this.moveToTrashAction="bonaire_move_to_trash";this.noMessagesMessage=BonaireWidget.no_messages_message;this.form=b("#bonaire-reply-form");this.bonaireReplyForm=b("form#bonaire_reply_form");this.bonaireReplyButton=b(".bonaire-submit-reply-button");this.bonaireReplyAction="bonaire_submit_reply";this.settingsPageDisplayStrings=BonaireSettingsPageDisplay.strings;this.connectionDetailsContainer=b("#connection_details");this.bonaireOptionsForm=b("#bonaire_settings_form");this.bonaireOptionsFormInputFields=this.connectionDetailsContainer.find("input, select, textarea");this.bonaireSaveOptionsButton=this.bonaireOptionsForm.find(".bonaire-save-options-button");this.bonaireResetOptionsButton=this.bonaireOptionsForm.find(".bonaire-reset-options-button");this.bonaireSendTestMailButton=this.connectionDetailsContainer.find(".bonaire-send-testmail-button");this.bonaireTestContactFormButton=this.connectionDetailsContainer.find(".bonaire-test-contact-form-button");this.bonaireTestSmtpSettingsButton=this.connectionDetailsContainer.find(".bonaire-test-smtp-settings-button");this.bonaireTestImapSettingsButton=this.connectionDetailsContainer.find(".bonaire-test-imap-settings-button");this.bonaireSaveOptionsAction="bonaire_save_options";this.resetOptionsAction="bonaire_reset_options";this.testConnectionAction="bonaire_evaluate_settings";this.testContactFormAction="bonaire_test_contact_form";this.testSmtpSettingsAction="bonaire_test_smtp_settings";this.testImapSettingsAction="bonaire_test_imap_settings";this.sendTestMailAction="bonaire_send_testmail";this.bonaireUpdateSettingsStatusAction="bonaire_get_settings_status";this.loaderSpinner=null}c.prototype={init:function(){this.setLoaderSpinner();this.setAlertify();this.initContextualHelp();this.addEvents()},setLoaderSpinner:function(){b("#wpbody").prepend('<div class="loader loader-default" data-text="'+this.optionsPageNotifications.working+'"></div>');this.loaderSpinner=b(".loader.loader-default");b(this.loaderSpinner).hide()},setAlertify:function(){a.defaults={autoReset:true,basic:false,closable:true,closableByDimmer:true,frameless:false,maintainFocus:true,maximizable:true,modal:true,movable:true,moveBounded:false,overflow:true,padding:true,pinnable:true,pinned:true,preventBodyShift:false,resizable:true,startMaximized:false,transition:"zoom",notifier:{delay:5,position:"bottom-right"},glossary:{title:"Bonaire",ok:this.alertifyNotifications.ok,cancel:this.alertifyNotifications.cancel},theme:{input:"ajs-input",ok:"ajs-ok",cancel:"ajs-cancel"}};b(".alertify").hide()},addEvents:function(){this.bonaireMarkAsReadButton.bind("click",{context:this,element:this.bonaireMarkAsReadButton},this.bonaireMarkAsRead);this.markAsSpamButton.bind("click",{context:this},this.bonaireMarkAsSpam);this.moveToTrashButton.bind("click",{context:this},this.bonaireMoveToTrash);this.handleDiv.bind("click",this.bonaireToggleWidgetContent);this.manageHandleDivs();this.bonaireReplyButton.bind("click",{context:this},this.bonaireReply);this.bonaireSaveOptionsButton.bind("click",{context:this},this.bonaireSaveOptions);this.bonaireResetOptionsButton.bind("click",{context:this},this.bonaireResetOptions);this.bonaireSendTestMailButton.bind("click",{context:this},this.promptForEmailAddress);this.bonaireTestContactFormButton.bind("click",{context:this,protocol:"cf7"},this.bonaireEvaluateSettings);this.bonaireTestSmtpSettingsButton.bind("click",{context:this,protocol:"smtp"},this.bonaireEvaluateSettings);this.bonaireTestImapSettingsButton.bind("click",{context:this,protocol:"imap"},this.bonaireEvaluateSettings);this.bonaireOptionsFormInputFields.bind("focus",{context:this},this.unsetInvalidInputFieldIndicator);this.helpButton.bind("click",{context:this},function(){b(".button.show-settings").trigger("click")})},bonaireMarkAsRead:function(e){var g=e.data.context;var d=b(this);var f={action:g.markAsReadAction,post_id:d.data("postid"),nonce:d.data("nonce")};b.post(ajaxurl,f,function(h){if(h.success===true){a.notify(h.data.message);b(d).parents("li").detach();g.updateWidgetDisplay()}else{a.error(h.data.message)}})},bonaireMarkAsSpam:function(e){var g=e.data.context;var d=b(this);var f={action:g.markAsSpamAction,post_id:d.data("postid"),nonce:d.data("nonce")};b.post(ajaxurl,f,function(h){if(h.success===true){a.notify(h.data.message);b(d).parents("li").detach();g.updateWidgetFooter("spam");g.updateWidgetDisplay()}else{a.error(h.data.message)}})},bonaireMoveToTrash:function(e){var g=e.data.context;var d=b(this);var f={action:g.moveToTrashAction,post_id:d.data("postid"),nonce:d.data("nonce")};b.post(ajaxurl,f,function(h){if(h.success===true){a.notify(h.data.message);b(d).parents("li").detach();g.updateWidgetFooter("trash");g.updateWidgetDisplay()}else{a.error(h.data.message)}})},updateWidgetFooter:function(d){var e=b("."+d+" ."+d+"-count");var f=parseInt(e.html())+1;e.html(f)},bonaireToggleWidgetContent:function(){var e=b(this).parents(".postbox");var d=e.find(".inside");if(e.hasClass("closed")){d.hide()}else{d.show()}},updateWidgetDisplay:function(){var d=b("#bonaire_dashboard_widget > .inside");var e=d.find("ul:first-of-type");if(e.find("li").length===0){d.prepend(this.noMessagesMessage)}},initContextualHelp:function(){b("#bonaire-help-tabs").tabs()},bonaireSaveOptions:function(f){f.preventDefault();var g=f.data.context;var e={};var d;b.each(b(g.bonaireOptionsFormInputFields),function(){if("bonaire"===b(this).data("form-input")){e[b(this).data("key")]=b(this).val()}});d=g.bonairePreValidateOptions(e);if(false!==d){g.bonaireSubmitOptions(d)}else{a.alert(g.optionsPageNotifications.save_options_notice)}},bonaireSubmitOptions:function(d){var f=this;var e={action:this.bonaireSaveOptionsAction,nonce:this.bonaireOptionsForm.data("nonce")};b.extend(e,d);this.showLoaderSpinner();b.post(ajaxurl,e,function(g){f.hideLoaderSpinner();if(undefined===g.data){g=b.parseJSON(g)}if(g.success===true){f.bonaireUpdateSettingsStatus();var h=b('input[name="bonaire_options[password]"]');if(""!==h.val()&&"*****"!==h.val()){h.val("*****")}a.success(g.data.message)}else{a.success(g.data.message)}})},bonaireUpdateSettingsStatus:function(){var e=this;var d={action:this.bonaireUpdateSettingsStatusAction,nonce:this.bonaireOptionsForm.data("nonce")};b.post(ajaxurl,d,function(f){if(undefined===f.data){f=b.parseJSON(f)}if(f.success===true){var i=f.data.cf7_status;if(undefined!==i){e.updateSettingsStatus("cf7",i)}var g=f.data.smtp_status;if(undefined!==g){e.updateSettingsStatus("smtp",g)}var h=f.data.imap_status;if(undefined!==h){e.updateSettingsStatus("imap",h)}}})},getSettingsStatus:function(f){var e={action:this.bonaireUpdateSettingsStatusAction,nonce:this.bonaireOptionsForm.data("nonce")};var d=null;b.post(ajaxurl,e,function(g){if(undefined===g.data){g=b.parseJSON(g)}if(g.success===true){if("smtp"===f){d=g.data.smtp_status}else{if("imap"===f){d=g.data.imap_status}else{d=g.data.cf7_status}}return d}return false})},bonaireResetOptions:function(e){e.preventDefault();var f=e.data.context;var d=this;a.set("confirm","title",f.resetOptionsConfirmation.title);a.confirm(f.resetOptionsConfirmation.text,function(){var g={action:f.resetOptionsAction,nonce:b(d).data("nonce")};f.showLoaderSpinner();b.post(ajaxurl,g,function(h){f.hideLoaderSpinner();if(undefined===h.data){h=b.parseJSON(h)}if(h.success===true){f.bonaireUpdateSettingsStatus();a.success(h.data.message);f.resetOptionsPageInputFields()}else{a.alert(h.data.message)}})})},bonaireEvaluateSettings:function(d){d.preventDefault();var f=d.data.context;var g=d.data.protocol;var e={};if("smtp"===g){e={action:f.testSmtpSettingsAction}}else{if("imap"===g){e={action:f.testImapSettingsAction}}else{e={action:f.testContactFormAction}}}b.extend(e,{nonce:b(this).data("nonce")});f.showLoaderSpinner();b.post(ajaxurl,e,function(h){if(undefined===h.data){h=b.parseJSON(h)}if(h.success===true){a.alert(h.data.message)}else{a.alert(h.data.message)}f.hideLoaderSpinner();f.bonaireUpdateSettingsStatus()})},promptForEmailAddress:function(f,d){f.preventDefault();var g=f.data.context;if(false===g.hasAppropriateSettingsStatus()){a.notify(g.optionsPageNotifications.send_test_mail_notice)}else{var e=true===d?g.optionsPageNotifications.send_test_mail_prompt_review_email_title:g.optionsPageNotifications.send_test_mail_prompt_title;a.prompt(e,"Please enter Email","Enter Email",function(h,j){var i={action:g.sendTestMailAction,nonce:b(".bonaire-send-testmail-button").data("nonce"),value:j};g.bonaireSendTestMail(f,i)},function(){a.notify("Sending test message canceled.")})}},bonaireSendTestMail:function(d,e){d.preventDefault();var f=d.data.context;f.showLoaderSpinner();b.post(ajaxurl,e,function(g){f.hideLoaderSpinner();if(undefined===g.data){g=b.parseJSON(g)}if(g.success===true){a.success(g.data.message)}else{if(g.success===false&&"email_not_valid"===g.data.error){f.promptForEmailAddress(d,true)}else{a.alert(g.data.message)}}})},updateSettingsStatus:function(f,d){var e=b("."+f).find(".status-indicator");b(e).removeClass("red orange green inactive").addClass(d);b(e).find("i").prop("title",this.settingsPageDisplayStrings[f][d])},hasAppropriateSettingsStatus:function(){var e=BonaireOptions.smtp_status;var d=BonaireOptions.imap_status;var f=BonaireOptions.save_reply;return"yes"===f?"1"===d:"1"===e},resetOptionsPageInputFields:function(){b.each(this.bonaireOptionsFormInputFields,function(){if("bonaire"===b(this).data("form-input")){var d=b(this).data("default-value");b(this).val(d);if("smtpsecure"===b(this).data("key")){b(this).val("ssl")}if("save_reply"===b(this).data("key")){b(this).val("no")}if("channel"===b(this).data("key")){b(this).val("none")}}})},bonairePreValidateOptions:function(f){var h=new RegExp(/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/i);var i=RegExp(/^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i);var d=new RegExp(/^[A-Za-z0-9 _.-]+$/);var g=this;var e={};var j={};b.each(f,function(l){var k=null;if("form_id"===l){k=""!==f.channel?f.channel.replace("_",""):""}if("number_posts"===l){k=b.isNumeric(parseInt(this))?this.toString():false;if(false!==k){k=this}else{k=""}}if("smtp_host"===l||"imap_host"===l){k=h.test(this);if(true===k){k=this.toLowerCase()}else{k=""}}if("smtpauth"===l){k=true}if("save_reply"===l||"password"===l||"channel"===l||"ssl_certification_validation"===l||"inbox_folder_name"===l||"inbox_folder_path"===l){k=this}if("smtp_port"===l||"imap_port"===l){k=b.isNumeric(parseInt(this))?parseInt(this):false;if(false!==k){k=this}else{k=""}}if("username"===l){if(this.indexOf("@")>=0){k=i.test(this)}else{k=d.test(this)}if(true===k){k=this}else{k=""}}if("smtpsecure"===l||"imapsecure"===l){k=null;if("ssl"===this||"tls"===this){k=this.toLowerCase()}else{k="ssl"}}if("from"===l){k=i.test(this);if(true===k){k=this.toLowerCase()}else{k=""}}if("fromname"===l){k=d.test(this);if(true===k){k=this}else{k=""}}if("your_name"===l||"your_email"===l||"your_subject"===l||"your_message"===l){k=d.test(this);if(true===k){k=this}else{k=""}}e[l]=k});if(false===b.isEmptyObject(j)){g.bonaireShowValidationErrors(j);return false}else{return e}},bonaireShowValidationErrors:function(e){var d=this;a.set("notifier","position","bottom-right");a.set("notifier","delay",1000);d.notification=a.error(d.bonaireGetValidationErrors(e));d.notification.ondismiss=function(){d.bonaireFailedValidationCallback(e)};d.body.one("click",function(){d.notification.dismiss()})},bonaireGetValidationErrors:function(e){var d='<div class="message-wrap mailinvalid-wrap">';d+="<h3>"+this.alertifyError.title+"</h3>";b.each(e,function(){d+='<div class="error-container"><strong>'+this.name+"</strong><span>"+this.error_message+"</span><span>("+this.example+")</span></div>"});d+="</div>";return d},bonaireFailedValidationCallback:function(e){var d=162;b.each(e,function(g){var f=g*d;b("input[name='bonaire_options["+this.id+"]']").delay(f).queue(function(h){b(this).addClass("has-error");h()})})},unsetInvalidInputFieldIndicator:function(){b(this).removeClass("has-error")},bonaireReply:function(f){f.preventDefault();var g=f.data.context;if(true===g.hasEmptyField){a.notify("<div>"+g.replyError.title+"</div><div><span>"+g.replyError.text+'</span><a href="'+g.replyError.link+'">'+g.replyError.link_text+"</a></div>")}else{if(b('[data-key="message"]').val()===""){a.notify("<div>"+g.emptyMessageError.title+"</div><div><span>"+g.emptyMessageError.text+"</span></div>")}else{var e=g.bonaireReplyForm.find("input:not(.bonaire-submit-reply-button), textarea");var d={};b.each(b(e),function(){if("bonaire"===b(this).data("form-input")){d[b(this).data("key")]=b(this).val()}});g.bonaireSubmitReply(d)}}},bonaireSubmitReply:function(d){var f=this;var e={action:this.bonaireReplyAction,nonce:this.bonaireReplyForm.data("nonce")};b.extend(e,d);this.showLoaderSpinner();b.post(ajaxurl,e,function(g){f.hideLoaderSpinner();if(undefined===g.data){g=b.parseJSON(g)}if(g.success===true){a.success(g.data.message);f.bonaireReplyForm.find("input[data-key='name']").val(BonaireOptions.from_name);f.bonaireReplyForm.find("textarea, input[type='subject']").val("RE: ");f.bonaireReplyForm.find("textarea, input[type='text']").val("")}else{a.alert(g.data.message)}})},showLoaderSpinner:function(){this.loaderSpinner.addClass("is-active");this.loaderSpinner.fadeIn(162)},hideLoaderSpinner:function(){this.loaderSpinner.fadeOut(162);this.loaderSpinner.removeClass("is-active")},manageHandleDivs:function(){if("1"===BonaireOptions.manage_handle_divs){b("#inboundfieldsdiv, #inboundmetadiv, #inboundconsentdiv").addClass("closed");b("#bonaire-message-meta-box, #bonaire-reply-meta-box").removeClass("closed")}else{b("#bonaire-message-meta-box, #inboundmetadiv, #inboundconsentdiv").addClass("closed");b("#inboundfieldsdiv, #bonaire-reply-meta-box").removeClass("closed")}}};b(document).one("ready",function(){var d=new c();d.init()})})(jQuery,alertify);